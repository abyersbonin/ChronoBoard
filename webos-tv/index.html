<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spa Eastman Dashboard</title>
    <meta name="theme-color" content="#00553f">
    
    <!-- webOS specific meta tags -->
    <meta name="webos:type" content="app">
    <meta name="webos:tv" content="true">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            cursor: none; /* Hide cursor for TV */
        }
        
        .dashboard-iframe {
            width: 100vw;
            height: 100vh;
            border: none;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, rgba(120, 140, 107, 0.9) 0%, rgba(172, 184, 164, 0.8) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease-out;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 2rem;
        }
        
        .loading-text {
            font-size: 1.8rem;
            color: white;
            text-align: center;
            font-weight: 300;
        }
        
        .spa-logo {
            font-size: 3rem;
            font-weight: 300;
            margin-bottom: 1rem;
            color: white;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 2000;
            display: none;
        }
        
        .connection-status.show {
            display: block;
        }
        
        .connection-status.online {
            background: rgba(40, 167, 69, 0.8);
        }
        
        .connection-status.offline {
            background: rgba(220, 53, 69, 0.8);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="spa-logo">Spa Eastman</div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Chargement du tableau de bord...</div>
    </div>

    <!-- Connection Status Indicator -->
    <div class="connection-status" id="connection-status">
        <span id="status-text">Connexion...</span>
    </div>

    <!-- Main Dashboard Iframe -->
    <iframe 
        id="dashboard-iframe"
        class="dashboard-iframe"
        src="https://chrono-board-tarnrsps.replit.app"
        allow="fullscreen"
        sandbox="allow-same-origin allow-scripts allow-forms allow-popups"
        loading="eager">
    </iframe>

    <script>
        // webOS TV App Configuration
        const DASHBOARD_URL = 'https://chrono-board-tarnrsps.replit.app';
        const RELOAD_INTERVAL = 30000; // 30 seconds
        
        let reloadTimer = null;
        let connectionCheckTimer = null;
        
        // Initialize app
        function initApp() {
            console.log('Spa Eastman Dashboard - webOS TV App starting...');
            
            const iframe = document.getElementById('dashboard-iframe');
            const loadingScreen = document.getElementById('loading-screen');
            const connectionStatus = document.getElementById('connection-status');
            
            // Handle iframe load events
            iframe.addEventListener('load', function() {
                console.log('Dashboard loaded successfully');
                hideLoadingScreen();
                updateConnectionStatus('online', 'Dashboard actif');
                startAutoReload();
            });
            
            iframe.addEventListener('error', function() {
                console.error('Dashboard failed to load');
                updateConnectionStatus('offline', 'Erreur de connexion');
                // Retry loading after 5 seconds
                setTimeout(() => {
                    reloadDashboard();
                }, 5000);
            });
            
            // Setup webOS TV remote control
            setupRemoteControl();
            
            // Start connection monitoring
            startConnectionMonitoring();
            
            // Handle app visibility changes
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    stopAutoReload();
                    stopConnectionMonitoring();
                } else {
                    reloadDashboard();
                    startAutoReload();
                    startConnectionMonitoring();
                }
            });
            
            // Initial connection test
            testConnection();
        }
        
        // Hide loading screen
        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loading-screen');
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }, 1500); // Show loading for at least 1.5 seconds
        }
        
        // Update connection status indicator
        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('connection-status');
            const statusText = document.getElementById('status-text');
            
            indicator.className = `connection-status show ${status}`;
            statusText.textContent = message;
            
            // Hide status after 3 seconds if online
            if (status === 'online') {
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 3000);
            }
        }
        
        // Test connection to dashboard
        async function testConnection() {
            try {
                const response = await fetch(DASHBOARD_URL, { 
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                return true;
            } catch (error) {
                console.warn('Connection test failed:', error);
                return false;
            }
        }
        
        // Reload dashboard iframe
        function reloadDashboard() {
            console.log('Reloading dashboard...');
            const iframe = document.getElementById('dashboard-iframe');
            
            // Add timestamp to force refresh
            const url = new URL(DASHBOARD_URL);
            url.searchParams.set('t', Date.now());
            iframe.src = url.toString();
            
            updateConnectionStatus('online', 'Actualisation...');
        }
        
        // Start automatic reload timer
        function startAutoReload() {
            stopAutoReload();
            reloadTimer = setInterval(() => {
                reloadDashboard();
            }, RELOAD_INTERVAL);
            console.log('Auto-reload started (30s interval)');
        }
        
        // Stop automatic reload timer
        function stopAutoReload() {
            if (reloadTimer) {
                clearInterval(reloadTimer);
                reloadTimer = null;
                console.log('Auto-reload stopped');
            }
        }
        
        // Start connection monitoring
        function startConnectionMonitoring() {
            stopConnectionMonitoring();
            connectionCheckTimer = setInterval(async () => {
                const isOnline = await testConnection();
                if (!isOnline) {
                    updateConnectionStatus('offline', 'Connexion perdue');
                    // Try to reload if offline
                    setTimeout(() => {
                        reloadDashboard();
                    }, 2000);
                }
            }, 60000); // Check every minute
        }
        
        // Stop connection monitoring
        function stopConnectionMonitoring() {
            if (connectionCheckTimer) {
                clearInterval(connectionCheckTimer);
                connectionCheckTimer = null;
            }
        }
        
        // Setup webOS TV remote control
        function setupRemoteControl() {
            document.addEventListener('keydown', function(event) {
                console.log('Key pressed:', event.keyCode);
                
                switch(event.keyCode) {
                    case 27: // BACK button
                        console.log('Back button pressed - closing app');
                        if (window.webOSSystem) {
                            window.webOSSystem.close();
                        } else {
                            // Fallback for testing
                            history.back();
                        }
                        break;
                        
                    case 13: // OK/Enter button
                        console.log('OK button pressed - reloading dashboard');
                        reloadDashboard();
                        break;
                        
                    case 412: // REWIND button
                        console.log('Rewind button pressed - force reload');
                        reloadDashboard();
                        break;
                        
                    case 417: // FAST FORWARD button
                        console.log('Fast forward button pressed - toggle auto-reload');
                        if (reloadTimer) {
                            stopAutoReload();
                            updateConnectionStatus('offline', 'Auto-reload désactivé');
                        } else {
                            startAutoReload();
                            updateConnectionStatus('online', 'Auto-reload activé');
                        }
                        break;
                        
                    case 19: // PAUSE button
                        console.log('Pause button pressed - pause/resume auto-reload');
                        if (reloadTimer) {
                            stopAutoReload();
                            updateConnectionStatus('offline', 'Pause');
                        } else {
                            startAutoReload();
                            updateConnectionStatus('online', 'Reprise');
                        }
                        break;
                }
                
                // Prevent default behavior for TV remote buttons
                event.preventDefault();
                event.stopPropagation();
            });
        }
        
        // Handle webOS system events
        if (window.webOS) {
            // webOS TV lifecycle events
            document.addEventListener('webOSLaunch', function(event) {
                console.log('webOS Launch event:', event);
                initApp();
            });
            
            document.addEventListener('webOSRelaunch', function(event) {
                console.log('webOS Relaunch event:', event);
                reloadDashboard();
            });
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
        
        // Error handling for iframe
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            updateConnectionStatus('offline', 'Erreur application');
        });
        
        // Handle unload to clean up timers
        window.addEventListener('beforeunload', function() {
            stopAutoReload();
            stopConnectionMonitoring();
        });
    </script>
</body>
</html>